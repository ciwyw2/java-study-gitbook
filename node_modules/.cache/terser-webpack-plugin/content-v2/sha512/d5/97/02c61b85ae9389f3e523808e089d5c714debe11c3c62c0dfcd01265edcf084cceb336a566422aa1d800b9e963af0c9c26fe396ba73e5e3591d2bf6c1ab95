{"code":"(window.webpackJsonp=window.webpackJsonp||[]).push([[355],{1179:function(t,e,s){\"use strict\";s.r(e);var a=s(42),n=Object(a.a)({},(function(){var t=this,e=t.$createElement,s=t._self._c||e;return s(\"ContentSlotsDistributor\",{attrs:{\"slot-key\":t.$parent.slotKey}},[s(\"h1\",{attrs:{id:\"jedispool资源池优化\"}},[s(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#jedispool资源池优化\"}},[t._v(\"#\")]),t._v(\" JedisPool资源池优化\")]),t._v(\" \"),s(\"h2\",{attrs:{id:\"_1-背景\"}},[s(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_1-背景\"}},[t._v(\"#\")]),t._v(\" 1. 背景\")]),t._v(\" \"),s(\"p\",[t._v(\"合理的jedisPool 资源池参数设置能为业务使用Redis保驾护航，本文将对JedisPool的使用、资源池的参数进行详细说明，最后给出“最合理”的配置\")]),t._v(\" \"),s(\"h2\",{attrs:{id:\"_2-使用方法\"}},[s(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_2-使用方法\"}},[t._v(\"#\")]),t._v(\" 2. 使用方法\")]),t._v(\" \"),s(\"h3\",{attrs:{id:\"_2-1-依赖关系\"}},[s(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_2-1-依赖关系\"}},[t._v(\"#\")]),t._v(\" 2.1 依赖关系\")]),t._v(\" \"),s(\"p\",[t._v(\"以官方的2.9.0为例子(\"),s(\"a\",{attrs:{href:\"https://github.com/xetorthio/jedis/releases\",target:\"_blank\",rel:\"noopener noreferrer\"}},[t._v(\"Jedis Release\"),s(\"OutboundLink\")],1),t._v(\")，Maven依赖如下：\")]),t._v(\" \"),s(\"div\",{staticClass:\"language- extra-class\"},[s(\"pre\",{pre:!0,attrs:{class:\"language-text\"}},[s(\"code\",[t._v(\"\\n<dependency>\\n    <groupId>redis.clients</groupId>\\n    <artifactId>jedis</artifactId>\\n    <version>2.9.0</version>\\n    <scope>compile</scope>\\n</dependency>\\n\\t\\n<dependency>\\n\\t<groupId>org.apache.commons</groupId>\\n\\t<artifactId>commons-pool2</artifactId>\\n\\t<optional>true</optional>\\n</dependency>\\n\")])])]),s(\"p\",[t._v(\"Jedis使用apache commons-pool2对Jedis资源池进行管理，所以在定义JedisPool时一个很重要的参数就是资源池GenericObjectPoolConfig，使用方式如下，其中有很多资源管理和使用的参数(具体看第二节)\")]),t._v(\" \"),s(\"p\",[s(\"strong\",[t._v(\"注意：后面会提到建议用JedisPoolConfig代替GenericObjectPoolConfig\")])]),t._v(\" \"),s(\"div\",{staticClass:\"language-java extra-class\"},[s(\"pre\",{pre:!0,attrs:{class:\"language-java\"}},[s(\"code\",[s(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[t._v(\"GenericObjectPoolConfig\")]),t._v(\" jedisPoolConfig \"),s(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[t._v(\"=\")]),t._v(\" \"),s(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[t._v(\"new\")]),t._v(\" \"),s(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[t._v(\"GenericObjectPoolConfig\")]),s(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\"(\")]),s(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\")\")]),s(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\";\")]),t._v(\"\\njedisPoolConfig\"),s(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\".\")]),s(\"span\",{pre:!0,attrs:{class:\"token function\"}},[t._v(\"setMaxTotal\")]),s(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\"(\")]),s(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\".\")]),s(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\".\")]),s(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\")\")]),s(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\";\")]),t._v(\"\\njedisPoolConfig\"),s(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\".\")]),s(\"span\",{pre:!0,attrs:{class:\"token function\"}},[t._v(\"setMaxIdle\")]),s(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\"(\")]),s(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\".\")]),s(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\".\")]),s(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\")\")]),s(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\";\")]),t._v(\"\\njedisPoolConfig\"),s(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\".\")]),s(\"span\",{pre:!0,attrs:{class:\"token function\"}},[t._v(\"setMinIdle\")]),s(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\"(\")]),s(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\".\")]),s(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\".\")]),s(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\")\")]),s(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\";\")]),t._v(\"\\njedisPoolConfig\"),s(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\".\")]),s(\"span\",{pre:!0,attrs:{class:\"token function\"}},[t._v(\"setMaxWaitMillis\")]),s(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\"(\")]),s(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\".\")]),s(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\".\")]),s(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\")\")]),s(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\";\")]),t._v(\"\\n\"),s(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\".\")]),s(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\".\")]),s(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\".\")]),t._v(\"\\n\")])])]),s(\"p\",[t._v(\"JedisPool的初始化如下：\")]),t._v(\" \"),s(\"div\",{staticClass:\"language- extra-class\"},[s(\"pre\",{pre:!0,attrs:{class:\"language-text\"}},[s(\"code\",[t._v(\"// redisHost和redisPort是实例的IP和端口\\n// redisPassword是实例的密码\\n// timeout，这里既是连接超时又是读写超时，从Jedis 2.8开始有区分connectionTimeout和soTimeout的构造函数\\n\\nJedisPool jedisPool = new JedisPool(jedisPoolConfig, redisHost, redisPort, timeout, redisPassword);\\n执行命令如下：\\nJedis jedis = null;\\ntry {\\n    jedis = jedisPool.getResource();\\n    //具体的命令\\n    jedis.executeCommand()\\n} catch (Exception e) {\\n    logger.error(e.getMessage(), e);\\n} finally {\\n    //注意这里不是关闭连接，在JedisPool模式下，Jedis会被归还给资源池。\\n    if (jedis != null) \\n        jedis.close();\\n}\\n\")])])]),s(\"h2\",{attrs:{id:\"_3-参数说明\"}},[s(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_3-参数说明\"}},[t._v(\"#\")]),t._v(\" 3. 参数说明\")]),t._v(\" \"),s(\"p\",[t._v(\"JedisPool保证资源在一个可控范围内，\"),s(\"strong\",[t._v(\"并且提供了线程安全\")]),t._v(\"，但是一个合理的GenericObjectPoolConfig配置能为应用使用Redis保驾护航，下面将对它的一些重要参数进行说明和建议：\")]),t._v(\" \"),s(\"p\",[t._v(\"在当前环境下，Jedis连接就是资源，JedisPool管理的就是Jedis连接。\")]),t._v(\" \"),s(\"h3\",{attrs:{id:\"_3-1-资源设置和使用\"}},[s(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_3-1-资源设置和使用\"}},[t._v(\"#\")]),t._v(\" 3.1 资源设置和使用\")]),t._v(\" \"),s(\"table\",[s(\"thead\",[s(\"tr\",[s(\"th\",[t._v(\"序号\")]),t._v(\" \"),s(\"th\",[t._v(\"参数名\")]),t._v(\" \"),s(\"th\",[t._v(\"含义\")]),t._v(\" \"),s(\"th\",[t._v(\"默认值\")]),t._v(\" \"),s(\"th\",[t._v(\"使用建议\")])])]),t._v(\" \"),s(\"tbody\",[s(\"tr\",[s(\"td\",[t._v(\"1\")]),t._v(\" \"),s(\"td\",[t._v(\"maxTotal\")]),t._v(\" \"),s(\"td\",[t._v(\"资源池中最大连接数\")]),t._v(\" \"),s(\"td\",[t._v(\"8\")]),t._v(\" \"),s(\"td\",[t._v(\"设置建议见下节\")])]),t._v(\" \"),s(\"tr\",[s(\"td\",[t._v(\"2\")]),t._v(\" \"),s(\"td\",[t._v(\"maxIdle\")]),t._v(\" \"),s(\"td\",[t._v(\"资源池允许最大空闲的连接数\")]),t._v(\" \"),s(\"td\",[t._v(\"8\")]),t._v(\" \"),s(\"td\",[t._v(\"设置建议见下节\")])]),t._v(\" \"),s(\"tr\",[s(\"td\",[t._v(\"3\")]),t._v(\" \"),s(\"td\",[t._v(\"minIdle\")]),t._v(\" \"),s(\"td\",[t._v(\"资源池确保最少空闲的连接数\")]),t._v(\" \"),s(\"td\",[t._v(\"0\")]),t._v(\" \"),s(\"td\",[t._v(\"设置建议见下节\")])]),t._v(\" \"),s(\"tr\",[s(\"td\",[t._v(\"4\")]),t._v(\" \"),s(\"td\",[t._v(\"blockWhenExhausted\")]),t._v(\" \"),s(\"td\",[t._v(\"当资源池用尽后，调用者是否要等待。只有当为true时，下面的maxWaitMillis才会生效\")]),t._v(\" \"),s(\"td\",[t._v(\"true\")]),t._v(\" \"),s(\"td\",[t._v(\"建议使用默认值\")])]),t._v(\" \"),s(\"tr\",[s(\"td\",[t._v(\"5\")]),t._v(\" \"),s(\"td\",[t._v(\"maxWaitMillis\")]),t._v(\" \"),s(\"td\",[t._v(\"当资源池连接用尽后，调用者的最大等待时间(单位为毫秒)\")]),t._v(\" \"),s(\"td\",[t._v(\"-1：表示永不超时\")]),t._v(\" \"),s(\"td\",[t._v(\"不建议使用默认值\")])]),t._v(\" \"),s(\"tr\",[s(\"td\",[t._v(\"6\")]),t._v(\" \"),s(\"td\",[t._v(\"testOnBorrow\")]),t._v(\" \"),s(\"td\",[t._v(\"向资源池借用连接时是否做连接有效性检测(ping)，无效连接会被移除\")]),t._v(\" \"),s(\"td\",[t._v(\"false\")]),t._v(\" \"),s(\"td\",[t._v(\"业务量很大时候建议设置为false(多一次ping的开销)。\")])]),t._v(\" \"),s(\"tr\",[s(\"td\",[t._v(\"7\")]),t._v(\" \"),s(\"td\",[t._v(\"testOnReturn\")]),t._v(\" \"),s(\"td\",[t._v(\"向资源池归还连接时是否做连接有效性检测(ping)，无效连接会被移除\")]),t._v(\" \"),s(\"td\",[t._v(\"false\")]),t._v(\" \"),s(\"td\",[t._v(\"业务量很大时候建议设置为false(多一次ping的开销)。\")])]),t._v(\" \"),s(\"tr\",[s(\"td\",[t._v(\"8\")]),t._v(\" \"),s(\"td\",[t._v(\"jmxEnabled\")]),t._v(\" \"),s(\"td\",[t._v(\"是否开启jmx监控，可用于监控\")]),t._v(\" \"),s(\"td\",[t._v(\"true\")]),t._v(\" \"),s(\"td\",[t._v(\"建议开启，但应用本身也要开启\")])])])]),t._v(\" \"),s(\"h3\",{attrs:{id:\"_3-2-空闲资源监测\"}},[s(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_3-2-空闲资源监测\"}},[t._v(\"#\")]),t._v(\" 3.2 空闲资源监测\")]),t._v(\" \"),s(\"p\",[t._v(\"空闲Jedis对象检测，下面四个参数组合来完成，testWhileIdle是该功能的开关。\")]),t._v(\" \"),s(\"table\",[s(\"thead\",[s(\"tr\",[s(\"th\",[t._v(\"序号\")]),t._v(\" \"),s(\"th\",[t._v(\"参数名\")]),t._v(\" \"),s(\"th\",[t._v(\"含义\")]),t._v(\" \"),s(\"th\",[t._v(\"默认值\")]),t._v(\" \"),s(\"th\",[t._v(\"使用建议\")])])]),t._v(\" \"),s(\"tbody\",[s(\"tr\",[s(\"td\",[t._v(\"1\")]),t._v(\" \"),s(\"td\",[t._v(\"testWhileIdle\")]),t._v(\" \"),s(\"td\",[t._v(\"是否开启空闲资源监测\")]),t._v(\" \"),s(\"td\",[t._v(\"false\")]),t._v(\" \"),s(\"td\",[t._v(\"true\")])]),t._v(\" \"),s(\"tr\",[s(\"td\",[t._v(\"2\")]),t._v(\" \"),s(\"td\",[t._v(\"timeBetweenEvictionRunsMillis\")]),t._v(\" \"),s(\"td\",[t._v(\"空闲资源的检测周期(单位为毫秒)\")]),t._v(\" \"),s(\"td\",[t._v(\"-1：不检测\")]),t._v(\" \"),s(\"td\",[t._v(\"建议设置，周期自行选择，也可以默认也可以使用下面JedisPoolConfig中的配置\")])]),t._v(\" \"),s(\"tr\",[s(\"td\",[t._v(\"3\")]),t._v(\" \"),s(\"td\",[t._v(\"minEvictableIdleTimeMillis\")]),t._v(\" \"),s(\"td\",[t._v(\"资源池中资源最小空闲时间(单位为毫秒)，达到此值后空闲资源将被移除\")]),t._v(\" \"),s(\"td\",[t._v(\"1000\"),s(\"em\",[t._v(\"60\")]),t._v(\" 30 = 30分钟\")]),t._v(\" \"),s(\"td\",[t._v(\"可根据自身业务决定，大部分默认值即可，也可以考虑使用下面JeidsPoolConfig中的配置\")])]),t._v(\" \"),s(\"tr\",[s(\"td\",[t._v(\"4\")]),t._v(\" \"),s(\"td\",[t._v(\"numTestsPerEvictionRun\")]),t._v(\" \"),s(\"td\",[t._v(\"做空闲资源检测时，每次的采样数\")]),t._v(\" \"),s(\"td\",[t._v(\"3\")]),t._v(\" \"),s(\"td\",[t._v(\"可根据自身应用连接数进行微调,如果设置为-1，就是对所有连接做空闲监测\")])])])]),t._v(\" \"),s(\"p\",[t._v(\"为了方便使用，Jedis提供了JedisPoolConfig，它本身继承了GenericObjectPoolConfig设置了一些空闲监测设置\")]),t._v(\" \"),s(\"div\",{staticClass:\"language- extra-class\"},[s(\"pre\",{pre:!0,attrs:{class:\"language-text\"}},[s(\"code\",[t._v(\"public class JedisPoolConfig extends GenericObjectPoolConfig {\\n  public JedisPoolConfig() {\\n    // defaults to make your life with connection pool easier :)\\n    setTestWhileIdle(true);\\n    //\\n    setMinEvictableIdleTimeMillis(60000);\\n    //\\n    setTimeBetweenEvictionRunsMillis(30000);\\n    setNumTestsPerEvictionRun(-1);\\n    }\\n}\\n\")])])]),s(\"p\",[t._v(\"所有默认值可以从org.apache.commons.pool2.impl.BaseObjectPoolConfig中看到。\")]),t._v(\" \"),s(\"h2\",{attrs:{id:\"_4-资源池大小-maxtotal-、空闲-maxidle-minidle-设置建议\"}},[s(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_4-资源池大小-maxtotal-、空闲-maxidle-minidle-设置建议\"}},[t._v(\"#\")]),t._v(\" 4. 资源池大小(maxTotal)、空闲(maxIdle minIdle)设置建议\")]),t._v(\" \"),s(\"h3\",{attrs:{id:\"_4-1-maxtotal-最大连接数\"}},[s(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_4-1-maxtotal-最大连接数\"}},[t._v(\"#\")]),t._v(\" 4.1.maxTotal：最大连接数\")]),t._v(\" \"),s(\"p\",[t._v(\"实际上这个是一个很难回答的问题，考虑的因素比较多：\")]),t._v(\" \"),s(\"ul\",[s(\"li\",[t._v(\"业务希望Redis并发量\")]),t._v(\" \"),s(\"li\",[t._v(\"客户端执行命令时间\")]),t._v(\" \"),s(\"li\",[t._v(\"Redis资源：例如 nodes(例如应用个数) * maxTotal 是不能超过redis的最大连接数。\")]),t._v(\" \"),s(\"li\",[t._v(\"资源开销：例如虽然希望控制空闲连接，但是不希望因为连接池的频繁释放创建连接造成不必靠开销。\")])]),t._v(\" \"),s(\"p\",[t._v(\"以一个例子说明，假设:\")]),t._v(\" \"),s(\"ul\",[s(\"li\",[t._v(\"一次命令时间（borrow|return resource + Jedis执行命令(含网络) ）的平均耗时约为1ms，一个连接的QPS大约是1000\")]),t._v(\" \"),s(\"li\",[t._v(\"业务期望的QPS是50000\")])]),t._v(\" \"),s(\"p\",[t._v(\"那么理论上需要的资源池大小是50000 / 1000 = 50个。但事实上这是个理论值，还要考虑到要比理论值预留一些资源，通常来讲maxTotal可以比理论值大一些。\")]),t._v(\" \"),s(\"p\",[t._v(\"但这个值不是越大越好，一方面连接太多占用客户端和服务端资源，另一方面对于Redis这种高QPS的服务器，一个大命令的阻塞即使设置再大资源池仍然会无济于事。\")]),t._v(\" \"),s(\"h3\",{attrs:{id:\"_4-2-maxidle-minidle\"}},[s(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_4-2-maxidle-minidle\"}},[t._v(\"#\")]),t._v(\" 4.2. maxIdle minIdle\")]),t._v(\" \"),s(\"p\",[t._v(\"maxIdle实际上才是业务需要的最大连接数，maxTotal是为了给出余量，所以maxIdle不要设置过小，否则会有new Jedis(新连接)开销，而minIdle是为了控制空闲资源监测。\")]),t._v(\" \"),s(\"p\",[t._v(\"连接池的最佳性能是maxTotal = maxIdle ,这样就避免连接池伸缩带来的性能干扰。但是如果并发量不大或者maxTotal设置过高，会导致不必要的连接资源浪费。\\n可以根据实际总OPS和调用redis客户端的规模整体评估每个节点所使用的连接池。\")]),t._v(\" \"),s(\"h3\",{attrs:{id:\"_4-3-监控\"}},[s(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_4-3-监控\"}},[t._v(\"#\")]),t._v(\" 4.3.监控\")]),t._v(\" \"),s(\"p\",[t._v(\"实际上最靠谱的值是通过监控来得到“最佳值”的，可以考虑通过一些手段(例如jmx)实现监控，找到合理值。\")]),t._v(\" \"),s(\"h3\",{attrs:{id:\"参考文章\"}},[s(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#参考文章\"}},[t._v(\"#\")]),t._v(\" 参考文章\")]),t._v(\" \"),s(\"p\",[s(\"a\",{attrs:{href:\"http://blog.didispace.com/JedisPool%E8%B5%84%E6%BA%90%E6%B1%A0%E4%BC%98%E5%8C%96/\",target:\"_blank\",rel:\"noopener noreferrer\"}},[t._v(\"JedisPool资源池优化\"),s(\"OutboundLink\")],1)])])}),[],!1,null,null,null);e.default=n.exports}}]);","extractedComments":[]}