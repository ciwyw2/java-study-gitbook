(window.webpackJsonp=window.webpackJsonp||[]).push([[19],{1032:function(t,a,s){"use strict";s.r(a);var e=s(42),r=Object(e.a)({},(function(){var t=this,a=t.$createElement,e=t._self._c||a;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("h1",{attrs:{id:"记一次mat分析线上项目过程"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#记一次mat分析线上项目过程"}},[t._v("#")]),t._v(" 记一次MAT分析线上项目过程")]),t._v(" "),e("h2",{attrs:{id:"_1-背景"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-背景"}},[t._v("#")]),t._v(" 1. 背景")]),t._v(" "),e("p",[t._v("前段时间接手了一个项目，正常运行都没有问题。但是"),e("strong",[t._v("运行个几天就会OOM异常")]),t._v("，导致服务不可用。我们首先第一个想到的就是该项目内存泄漏导致，但是项目本身已经比较庞大，要找到一个内存泄漏的点，还是比较难得。")]),t._v(" "),e("p",[t._v("所以我们使用MAT来分析线上项目的运行情况")]),t._v(" "),e("h2",{attrs:{id:"_2-jmap-生成堆转储快照"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-jmap-生成堆转储快照"}},[t._v("#")]),t._v(" 2. "),e("code",[t._v("jmap")]),t._v(":生成堆转储快照")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("jmap -dump:format=b,file=./heap.hprof 19012\nDumping heap to /home/ftpuser/services/mywebsocket/heap.hprof ...\nHeap dump file created\n")])])]),e("p",[t._v("19012 是进程号")]),t._v(" "),e("p",[t._v("我们将heap.hprof 导出到我们本地，使用MAT来分析")]),t._v(" "),e("h2",{attrs:{id:"_3-mat分析"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-mat分析"}},[t._v("#")]),t._v(" 3. MAT分析")]),t._v(" "),e("h3",{attrs:{id:"_3-1-查看内存泄漏疑点报告"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-查看内存泄漏疑点报告"}},[t._v("#")]),t._v(" 3.1 查看内存泄漏疑点报告")]),t._v(" "),e("p",[t._v("这是最简单有效的方式，我们根据报告的提示来进行分析")]),t._v(" "),e("p",[e("img",{attrs:{src:s(405),alt:"image-20200107232248818"}})]),t._v(" "),e("p",[t._v("我们点开报告得到")]),t._v(" "),e("p",[e("img",{attrs:{src:s(406),alt:"image-20200107232335036"}})]),t._v(" "),e("p",[t._v("我们根据报告得知，有个对象已经占用了44.4 MB的内存，他来源于"),e("strong",[t._v("ConcurrentHashMap$Node[]")])]),t._v(" "),e("h3",{attrs:{id:"_3-2-查看histogram"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-查看histogram"}},[t._v("#")]),t._v(" 3.2 查看Histogram")]),t._v(" "),e("p",[t._v("通过查看"),e("strong",[t._v("Histogram")]),t._v("，列出内存中的对象情况（个数，大小）")]),t._v(" "),e("p",[e("img",{attrs:{src:s(407),alt:"image-20200107233119349"}})]),t._v(" "),e("ul",[e("li",[e("p",[e("strong",[t._v("Class Name")]),t._v(" ： 类名称，java类名")])]),t._v(" "),e("li",[e("p",[t._v("**Objects **： 类的对象的数量，这个对象被创建了多少个")])]),t._v(" "),e("li",[e("p",[e("strong",[t._v("Shallow Heap ：一个对象内存的消耗大小，不包含对其他对象的引用")])])]),t._v(" "),e("li",[e("p",[e("strong",[t._v("Retained Heap ：是shallow Heap的总和，也就是该对象被GC之后所能回收到内存的总和")])])])]),t._v(" "),e("h4",{attrs:{id:"_3-2-1-通过正则查找自己的类"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-1-通过正则查找自己的类"}},[t._v("#")]),t._v(" 3.2.1 通过正则查找自己的类")]),t._v(" "),e("p",[t._v("这儿借助工具提供的regex正则搜索一下我们自己的类，排序后看看哪些相对是占用比较大的。")]),t._v(" "),e("p",[e("img",{attrs:{src:s(408),alt:"image-20200107233400178"}})]),t._v(" "),e("p",[t._v("我们可以看出内存泄漏是有EsscWebSocket开始的")]),t._v(" "),e("h3",{attrs:{id:"_3-3-查看dominator-tree"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-查看dominator-tree"}},[t._v("#")]),t._v(" 3.3 查看Dominator Tree")]),t._v(" "),e("p",[e("img",{attrs:{src:s(409),alt:"image-20200107233826983"}})]),t._v(" "),e("h3",{attrs:{id:"_3-4-top-consumers"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-4-top-consumers"}},[t._v("#")]),t._v(" 3.4 Top consumers")]),t._v(" "),e("p",[e("img",{attrs:{src:s(410),alt:"image-20200107233905138"}})]),t._v(" "),e("p",[e("strong",[t._v("这张图展示的是占用内存比较多的****对象的分布，下面是具体的一些类和占用。")])]),t._v(" "),e("p",[e("img",{attrs:{src:s(411),alt:"image-20200107234011953"}})]),t._v(" "),e("h2",{attrs:{id:"参考文章"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#参考文章"}},[t._v("#")]),t._v(" 参考文章")]),t._v(" "),e("p",[e("a",{attrs:{href:"https://www.cnblogs.com/AloneSword/p/3821569.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("Java程序内存分析：使用mat工具分析内存占用"),e("OutboundLink")],1)])])}),[],!1,null,null,null);a.default=r.exports},405:function(t,a,s){t.exports=s.p+"assets/img/image-20200107232248818.290c0edd.png"},406:function(t,a,s){t.exports=s.p+"assets/img/image-20200107232335036.5fc921b3.png"},407:function(t,a,s){t.exports=s.p+"assets/img/image-20200107233119349.12fd2080.png"},408:function(t,a,s){t.exports=s.p+"assets/img/image-20200107233400178.77b69bae.png"},409:function(t,a,s){t.exports=s.p+"assets/img/image-20200107233826983.23093ba4.png"},410:function(t,a,s){t.exports=s.p+"assets/img/image-20200107233905138.3f28c530.png"},411:function(t,a,s){t.exports=s.p+"assets/img/image-20200107234011953.785ebc6d.png"}}]);