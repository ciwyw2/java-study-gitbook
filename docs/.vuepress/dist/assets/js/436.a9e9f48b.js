(window.webpackJsonp=window.webpackJsonp||[]).push([[436],{905:function(t,s,a){"use strict";a.r(s);var e=a(42),r=Object(e.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"gitlab配置custom-hook"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#gitlab配置custom-hook"}},[t._v("#")]),t._v(" gitlab配置custom hook")]),t._v(" "),a("h2",{attrs:{id:"_1-具体步骤"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-具体步骤"}},[t._v("#")]),t._v(" 1. 具体步骤")]),t._v(" "),a("h3",{attrs:{id:"_1-1-设置custom-hooks路径"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-设置custom-hooks路径"}},[t._v("#")]),t._v(" 1.1 设置custom_hooks路径")]),t._v(" "),a("p",[t._v("修改 gitlab 中的"),a("code",[t._v("vi /etc/gitlab/gitlab.rb")])]),t._v(" "),a("p",[t._v("增加 custom_hooks_dir 路径：")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("gitlab_shell['custom_hooks_dir'] = \"/opt/gitlab/embedded/service/gitlab-shell/hooks\"\n")])])]),a("p",[t._v("注：这里直接去掉注释使用自带的")]),t._v(" "),a("h3",{attrs:{id:"_1-2-启用配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-启用配置"}},[t._v("#")]),t._v(" 1.2 启用配置")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("sudo gitlab-ctl reconfigure\n")])])]),a("h3",{attrs:{id:"_1-3-创建hook文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-创建hook文件"}},[t._v("#")]),t._v(" 1.3 创建hook文件")]),t._v(" "),a("p",[t._v("自定义脚本目录要符合"),a("code",[t._v("<custom_hooks_dir>/<hook_name.d>/*")]),t._v(" 的规范。具体就是")]),t._v(" "),a("ul",[a("li",[a("p",[t._v("在自定的"),a("code",[t._v("custom_hooks_dir")]),t._v(" 目录下可创建三个文件夹对应三类 "),a("code",[t._v("server hook name")]),t._v(" ：")]),t._v(" "),a("ul",[a("li",[t._v("pre-receive.d")]),t._v(" "),a("li",[t._v("update.d")]),t._v(" "),a("li",[t._v("post-receive.d")])])]),t._v(" "),a("li",[a("p",[t._v("在每个文件夹下可以创建任意文件，在对应的hook时期，gitlab就会主动调用")])]),t._v(" "),a("li",[a("p",[t._v("文件名以"),a("code",[t._v("~")]),t._v("结尾的文件会被忽略")])]),t._v(" "),a("li",[a("p",[t._v("如果想看这部分的实现细节可以看 "),a("code",[t._v("<gitlab-shell>/lib/gitlab_custom_hook.rb")]),t._v(" 文件")])])]),t._v(" "),a("p",[t._v("目录结构示意")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("[root@localhost custom_hooks]# tree\n.\n├── post-receive.d\n│   ├── 01.sh\n│   └── 02.sh~\n├── pre-receive.d\n│   ├── 01.sh\n│   ├── 02.py\n│   └── 03.rb\n└── update.d\n    ├── 01.sh\n    └── 02.sh\n")])])]),a("h3",{attrs:{id:"_1-4-编写-hook-脚本"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-4-编写-hook-脚本"}},[t._v("#")]),t._v(" 1.4 编写 hook 脚本")]),t._v(" "),a("p",[t._v("hook 脚本就是git 自身的规范，写shell，python、ruby 都可以")]),t._v(" "),a("p",[t._v("留意脚本最后的退出值："),a("strong",[t._v("0 正常退出，用户可以 push；非 0 异常退出，中断提交（pre-receive 和 update）")]),t._v(" 。\n细节参见： "),a("a",{attrs:{href:"https://link.jianshu.com/?t=https://github.com/geeeeeeeeek/git-recipes/wiki/5.4-Git%E9%92%A9%E5%AD%90%EF%BC%9A%E8%87%AA%E5%AE%9A%E4%B9%89%E4%BD%A0%E7%9A%84%E5%B7%A5%E4%BD%9C%E6%B5%81",target:"_blank",rel:"noopener noreferrer"}},[t._v("5.4 Git钩子：自定义你的工作流 · geeeeeeeeek/git-recipes Wiki · GitHub"),a("OutboundLink")],1)]),t._v(" "),a("p",[t._v("如果想让用户 push 时看到相应的日志直接在脚本中 echo 即可。")]),t._v(" "),a("p",[t._v("这里举两个例子：")]),t._v(" "),a("p",[t._v("🌰：Say hi.")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token shebang important"}},[t._v("#!/bin/sh")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Say hi from gitlab servertes ok 😄"')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("exit")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n")])])]),a("p",[t._v("🌰：检查提交修改的文件，发现有特定内容禁止提交")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("#!/bin/sh\nFIND_KEY='.test.51offer.com'\nOLD_VALUE=$2\nNEW_VALUE=$3\n\nFILES=$(git rev-list --objects $OLD_VALUE...$NEW_VALUE | egrep '\\.(jsp|vm|java)$' | awk '{print $2}' | sort | uniq )\n\nFLAG=0\nfor FILE in $FILES\ndo\n    git show $NEW_VALUE:$FILE | grep -q \"$FIND_KEY\"\n    if [ $? -eq 0 ]\n    then\n        FLAG=1\n        echo \"📃  包含非法字段 '$FIND_KEY' : $FILE\"\n    fi\ndone\n\nif [ $FLAG -eq 0 ]\nthen\n    echo \"✅  代码检查通过.\"\nelse\n    echo \"❌  代码检查不通过!\"\n    exit 1\nfi\n\nexit 0\n")])])]),a("p",[t._v("例子结果")]),t._v(" "),a("p",[t._v("上面第二个例子中，尝试 "),a("code",[t._v("git push")]),t._v("，就能看到如下的日志：")]),t._v(" "),a("div",{staticClass:"language-ruby extra-class"},[a("pre",{pre:!0,attrs:{class:"language-ruby"}},[a("code",[a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("Pushing")]),t._v(" to git"),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("@gitlab")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".51")]),t._v("offer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("inner"),a("span",{pre:!0,attrs:{class:"token symbol"}},[t._v(":mall")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("paycenter"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("git\nremote"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 📃  包含非法字段 "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'.test.51offer.com'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" service"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("src"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("main"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("java"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("com"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("horizon"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("module")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("paycenter"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("service"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("PayService")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("java        \nremote"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ❌  代码检查不通过"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("        \nremote"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" error"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" hook declined to update refs"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("heads"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("test        \n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("To")]),t._v(" git"),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("@gitlab")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".51")]),t._v("offer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("inner"),a("span",{pre:!0,attrs:{class:"token symbol"}},[t._v(":mall")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("paycenter"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("git\n "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("up to date"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("      release"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("old "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" release"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("old\n "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("up to date"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("      v1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".2016")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".9")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".8")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" v1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".2016")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".9")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".8")]),t._v("\n "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("remote rejected"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" test "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" test "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("hook declined"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nerror"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" failed to push some refs to "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'git@gitlab.51offer.inner:mall/paycenter.git'")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("Completed")]),t._v(" with errors"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" see above\n")])])]),a("h3",{attrs:{id:"参考文章"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#参考文章"}},[t._v("#")]),t._v(" 参考文章")]),t._v(" "),a("p",[a("a",{attrs:{href:"https://www.jianshu.com/p/5531a21afa68",target:"_blank",rel:"noopener noreferrer"}},[t._v("Gitlab 服务器端 custom hook 配置"),a("OutboundLink")],1)]),t._v(" "),a("p",[a("a",{attrs:{href:"https://docs.gitlab.com/ee/administration/custom_hooks.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("官方文档"),a("OutboundLink")],1)])])}),[],!1,null,null,null);s.default=r.exports}}]);